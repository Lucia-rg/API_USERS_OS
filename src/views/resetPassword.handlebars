<h2>Restablecer Contraseña</h2>

{{#if status '==' 'invalid'}}
    <div style="color: red;">
        <p>{{message}}</p>
        <p>Por favor, solicita un nuevo enlace de recuperación.</p>
        <a href="/login">Ir a Login</a>
    </div>
{{/if}}

{{#if status '==' 'valid'}}
    <form id="resetForm" data-token="{{token}}">
        <label for="newPassword">Nueva Contraseña:</label>
        <input type="password" id="newPassword" name="newPassword" required>
        
        <label for="confirmPassword">Confirmar Contraseña:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required>
        
        <button type="submit">Guardar Nueva Contraseña</button>
        
        <div id="message" style="margin-top: 15px;"></div>
    </form>

    <script>
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = e.target.getAttribute('data-token');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('message');

            if (newPassword !== confirmPassword) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Las contraseñas no coinciden.';
                return;
            }

            try {
                const response = await fetch(`/api/sessions/reset-password/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = result.message + ' Redirigiendo...';
                    setTimeout(() => {
                        window.location.href = '/login'; // Redirigir a la vista de login
                    }, 3000);
                } else {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = result.message;
                }
            } catch (error) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Error de conexión al servidor.';
            }
        });
    </script>
{{/if}}<h2>Restablecer Contraseña</h2>

{{#if status '==' 'invalid'}}
    <div style="color: red;">
        <p>{{message}}</p>
        <p>Por favor, solicita un nuevo enlace de recuperación.</p>
        <a href="/login">Ir a Login</a>
    </div>
{{/if}}

{{#if status '==' 'valid'}}
    <form id="resetForm" data-token="{{token}}">
        <label for="newPassword">Nueva Contraseña:</label>
        <input type="password" id="newPassword" name="newPassword" required>
        
        <label for="confirmPassword">Confirmar Contraseña:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required>
        
        <button type="submit">Guardar Nueva Contraseña</button>
        
        <div id="message" style="margin-top: 15px;"></div>
    </form>

    <script>
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = e.target.getAttribute('data-token');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('message');

            if (newPassword !== confirmPassword) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Las contraseñas no coinciden.';
                return;
            }

            try {
                const response = await fetch(`/api/sessions/reset-password/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = result.message + ' Redirigiendo...';
                    setTimeout(() => {
                        window.location.href = '/login'; // Redirigir a la vista de login
                    }, 3000);
                } else {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = result.message;
                }
            } catch (error) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Error de conexión al servidor.';
            }
        });
    </script>
{{/if}}